# Somnus CLI

Somnus comes with a CLI that allows you to generate audio data and train your own keyword detection model. The CLI is implemented using Python-Fire. For each command you can use `-h` or `--help` to get a description of the command and a list of the possible arguments/options for the command.

To start using the CLI run `somnus configure` to create the configuration for the Somnus CLI. Then the raw data directory must contain three sub-directories:

* `positives/` for audio files containing utterances of the keyword. Must contain at least 1 audio file.
* `negatives/` for audio files containing speech that does not contain utterances of the keyword. Must contain at least 1 audio file.
* `backgrounds/` for audio files that contain background noise. This directory is optional but we recommend adding noise to the training data so that the keyword detector also works in noisy conditions.

The CLI currently supports the following audio types: **wav, mp3, flac, ogg, flv, wma, aac**

## Configure

```bash
somnus configure
```

Create a configuration file with the absolute paths to the:

* Raw audio data directory
* Directory that should contain the augmented audio files
* Directory that should contain the preprocessed data files

**Note** that the augmented audio files and preprocessed data files can use a lot of space so make sure to put them on a drive with a lot of available space.

## Augmenting audio

```bash
somnus augment_audio
```

The command to generate an audio dataset takes the raw audio in your raw audio directory as input and generates positive, negative, and silent audio files with varying amounts of background noise. These audio files are written to the augmented audio directory.
 
**Arguments**
* **duration**: The duration of the audio clips in seconds  
* **positive**: The number of positive examples  
* **negative**: The number of negative examples  
* **silent**: The number of examples containing only background noise  

## Preprocessing and creating the dataset
```bash
somnus preprocess
```

The command to preprocess the augmented audio files. It takes the files stored in the augmented audio directory, normalizes them and stores the output array in the preprocessed data directory.

**Arguments**
* **filters**: The number of filters in each frame  
* **show_progress**: Boolean option to decide whether to show a progress bar  
* **split**: The split between train, validation, and test data. The total should add up to 1. E.g. `(0.9, 0.05, 0.05)`  
* **win_length**: The length of each window in seconds  
* **win_hop**: the time between the start of each consecutive window.  

## Training

```bash
somnus train
```

The command to train a small-footprint keyword model loads the data in `./preprocessed_data/` and uses it to train the keyword model.

**Arguments**
* **model_name**: The name of the model we want to train  
* **epochs**: The number of epochs  
* **weights_file**: The name of the file the final weights should be saved to  
* **save_best**: Whether or not the model should save the best model throughout the training process  
* **batch_size**: The size of each mini batch  
* **lr**: The initial learning rate  

## Testing

```bash
somnus test
```

The command to test a trained model on a witheld test dataset.

**Arguments**
* **model**: The file containing the model we want to test

#### List microphones

```bash
somnus list_microphones
```

Prints out a list of microphones connected to your device along with their device IDs.

## Cleanup files

```bash
somnus cleanup
```

Removes all the data files that have been generated by the CLI in the Augmented Audio Directory and the Preprocessed Data Directory


## Quantize model

```bash
somnus quantize_model
```

Converts the model to a format compatible with Tensorflow Lite (tflite) and quantizes it. Quantizing the model reduces the size of the model by a factor of 2-4 while barely reducing the total accuracy of the model.

The CLI offers two different methods for quantization:

| Option | Quantization Method        | Benefits                     | Hardware |
|--------|----------------------------|------------------------------|----------|
| CPU    | Dynamic range quantization | 4x smaller, 2x-3x speedup    | CPU      |
| GPU    | Float16 quantization       | 2x smaller, GPU acceleration | CPU, GPU |

**Arguments**

* **model**: The file containing the model we want to convert
* **output**: The file that the TFLite model will be written to
* **quantization**: The hardware that the model should be optimized for (CPU, GPU)

## Testing Quantized model

```bash
somnus test_quantized_model
```

The command to test a quantized model on a witheld test dataset.

**Arguments**
* **model**: The file containing the model we want to test